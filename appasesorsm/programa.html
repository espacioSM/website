<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura SM Engine | espacioSM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary-color: #FFCD00; --primary-dark: #E6B800; }
        body { font-family: 'Inter', sans-serif; color: #000000; background-color: #FFFFFF; }
        
        .nav-scrolled { background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        .sm-card { border: 3px solid #000; box-shadow: 12px 12px 0px 0px var(--primary-color); }
        .btn-primary-sm { background-color: var(--primary-color); color: #000; font-weight: 800; text-transform: uppercase; transition: all 0.3s; border: 2px solid #000; letter-spacing: 0.1em; }
        .btn-primary-sm:hover { background-color: #000; color: var(--primary-color); transform: translateY(-2px); }
        
        .input-underline { border-bottom: 2px solid #000; width: 100%; padding: 12px 0; font-weight: 700; text-transform: uppercase; outline: none; background: transparent; }
        .btn-option { border: 2px solid #E5E7EB; padding: 14px; text-align: left; font-weight: 700; font-size: 11px; text-transform: uppercase; transition: 0.2s; width: 100%; }
        .btn-option:hover, .btn-option.active { border-color: #000; background-color: var(--primary-color); }

        .visual-card { border: 2px solid #E5E7EB; cursor: pointer; transition: 0.3s; }
        .visual-card:hover, .visual-card.active { border-color: #000; box-shadow: 5px 5px 0px 0px var(--primary-color); }

        .aura-bubble { animation: float 3s ease-in-out infinite; z-index: 1000; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .aura-chat { background-color: #000; border-left: 6px solid #FFCD00; }
    </style>
</head>
<body class="antialiased">

    <nav id="navbar" class="fixed top-0 left-0 right-0 z-50 transition-all duration-300 py-4 nav-scrolled">
        <div class="max-w-7xl mx-auto px-6 md:px-12 flex justify-between items-center">
            <a href="https://www.espaciosm.art" class="flex items-center">
                <span class="text-xl font-bold text-gray-800">espacio<span class="text-[#FFCD00]">SM</span></span>
            </a>
            <div class="hidden md:flex items-center space-x-8">
                <a href="/casa-del-arbol/del-arbol.html" class="text-gray-800 hover:text-[#FFCD00] font-bold text-[11px] uppercase tracking-widest">Proyectos</a>
                <a href="/contacto.html" class="text-gray-800 hover:text-[#FFCD00] font-bold text-[11px] uppercase tracking-widest">Contacto</a>
                <a href="#engine-start" class="bg-[#FFCD00] text-black px-4 py-2 rounded-md font-black text-[10px] uppercase tracking-widest border-2 border-black">Consultar Proyecto</a>
            </div>
        </div>
    </nav>

    <!-- Aura SM Modal Chat -->
    <div id="auraModal" class="fixed inset-0 bg-black bg-opacity-90 z-[1001] hidden items-center justify-center p-4">
        <div class="bg-white sm-card max-w-2xl w-full max-h-[80vh] flex flex-col">
            <div class="bg-black p-4 flex justify-between items-center border-b-4 border-[#FFCD00]">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-[#FFCD00] flex items-center justify-center text-black font-black border-2 border-white">SM</div>
                    <span class="text-white text-[12px] font-black uppercase tracking-[0.2em]">Aura SM · Estrategia</span>
                </div>
                <button onclick="closeAuraModal()" class="text-white hover:text-[#FFCD00] text-xl font-bold">&times;</button>
            </div>
            <div id="auraChatMessages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50">
                <div class="flex gap-3 items-start">
                    <div class="w-8 h-8 rounded-full bg-black flex-shrink-0 flex items-center justify-center border border-[#FFCD00]">
                        <i class="fas fa-robot text-[#FFCD00] text-xs"></i>
                    </div>
                    <div class="bg-white p-3 border-2 border-black text-[11px] font-bold leading-relaxed max-w-[80%]">
                        Aura SM: Soy la inteligencia estratégica de espacioSM. Estoy analizando tu diagnóstico. ¿Qué necesitas saber?
                    </div>
                </div>
            </div>
            <div class="p-4 border-t-2 border-black bg-white">
                <div class="flex gap-2">
                    <input type="text" id="auraChatInput" placeholder="ESCRIBE TU CONSULTA..." class="flex-1 border-2 border-black p-3 text-[10px] font-bold uppercase" onkeypress="if(event.key==='Enter') sendAuraMessage()">
                    <button onclick="sendAuraMessage()" class="bg-black text-[#FFCD00] px-6 py-3 text-[10px] font-black uppercase tracking-wider border-2 border-[#FFCD00]">Enviar</button>
                </div>
                <p class="text-[7px] text-gray-500 mt-2 font-bold uppercase">Tus datos están protegidos · Uso exclusivo para ficha técnica espacioSM</p>
            </div>
        </div>
    </div>

    <div onclick="openAuraModal()" class="aura-bubble fixed bottom-8 right-8 cursor-pointer flex flex-col items-center">
        <div class="bg-black text-[#FFCD00] w-14 h-14 rounded-full flex items-center justify-center shadow-2xl border-2 border-[#FFCD00]">
            <i class="fas fa-robot text-2xl"></i>
        </div>
        <span class="bg-black text-white text-[7px] font-black px-2 py-1 rounded mt-2 uppercase tracking-tighter">Consultar Aura SM</span>
    </div>

    <section id="engine-start" class="pt-32 pb-20 px-6 bg-gray-50 min-h-screen">
        <div class="max-w-2xl mx-auto">
            
            <div id="tracker" class="hidden flex justify-between mb-12 relative px-4">
                <div class="absolute top-5 left-0 w-full h-[1px] bg-gray-200 z-0"></div>
                <div id="prog-line" class="absolute top-5 left-0 h-[2px] bg-black z-0 transition-all duration-700" style="width: 0%;"></div>
                <div class="relative z-10 flex flex-col items-center"><div id="d-1" class="w-8 h-8 rounded-full bg-black text-[#FFCD00] flex items-center justify-center border-2 border-[#FFCD00] text-[10px] font-bold">1</div><span class="text-[7px] font-black mt-1 uppercase">Contexto</span></div>
                <div class="relative z-10 flex flex-col items-center"><div id="d-2" class="w-8 h-8 rounded-full bg-white border-2 border-gray-200 text-gray-300 flex items-center justify-center text-[10px] font-bold">2</div><span class="text-[7px] font-black mt-1 uppercase">Gente</span></div>
                <div class="relative z-10 flex flex-col items-center"><div id="d-3" class="w-8 h-8 rounded-full bg-white border-2 border-gray-200 text-gray-300 flex items-center justify-center text-[10px] font-bold">3</div><span class="text-[7px] font-black mt-1 uppercase">Equipo</span></div>
                <div class="relative z-10 flex flex-col items-center"><div id="d-4" class="w-8 h-8 rounded-full bg-white border-2 border-gray-200 text-gray-300 flex items-center justify-center text-[10px] font-bold">4</div><span class="text-[7px] font-black mt-1 uppercase">Estética</span></div>
            </div>

            <div class="bg-white sm-card rounded-sm overflow-hidden">
                <div class="bg-black p-4 flex justify-between items-center text-white border-b-4 border-[#FFCD00]">
                    <span class="text-[10px] font-black uppercase tracking-[0.3em]">Aura SM Engine</span>
                    <div class="flex items-center gap-2"><div class="w-2 h-2 bg-[#FFCD00] rounded-full animate-pulse"></div><span class="text-[8px] font-bold">ACTIVO</span></div>
                </div>

                <div id="main-render" class="p-8 md:p-12 min-h-[460px] flex flex-col justify-center">
                    <div class="fade-in space-y-6">
                        <h2 class="text-3xl font-black uppercase italic tracking-tighter">Consultoría de Autor</h2>
                        <p class="text-[11px] font-bold text-gray-600 uppercase leading-relaxed">
                            Bienvenido al motor de diagnóstico de <strong>espacioSM</strong>. <br><br>
                            A continuación, definiremos los parámetros de tu proyecto. Durante el proceso, <strong>Aura SM</strong> te acompañará resolviendo dudas técnicas y brindándote tips estratégicos para proteger tu inversión.
                        </p>
                        <div class="bg-yellow-50 p-4 border-l-4 border-black text-[10px] font-bold uppercase">
                            * Puedes interactuar con Aura SM en cualquier momento usando el botón flotante.
                        </div>
                        <button onclick="initQuiz()" class="btn-primary-sm w-full py-5 text-sm">Iniciar Diagnóstico</button>
                    </div>
                </div>

                <div id="tip-box" class="hidden bg-gray-50 border-t-2 border-black p-6">
                    <div class="flex gap-4 items-start">
                        <div class="w-10 h-10 rounded-full bg-[#FFCD00] flex items-center justify-center text-[10px] font-black italic border-2 border-black flex-shrink-0">SM</div>
                        <div class="space-y-1 w-full">
                            <p class="text-[8px] font-black uppercase text-white bg-black px-2 py-0.5 inline-block">Tip de espacioSM</p>
                            <p id="tip-text" class="text-[11px] font-bold italic text-gray-700 leading-relaxed uppercase tracking-tight"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-black text-gray-300 py-12 px-6 md:px-12 border-t-4 border-[#FFCD00]">
        <div class="max-w-6xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                <div>
                    <h3 class="text-white text-lg font-semibold mb-4">Contacto</h3>
                    <p class="text-[12px] mb-2">Ciudad de México, México</p>
                    <a href="mailto:contacto@espaciosm.art" class="block mb-2 hover:text-[#FFCD00] text-[12px]">contacto@espaciosm.art</a>
                    <a href="tel:+525613870288" class="block hover:text-[#FFCD00] text-[12px] font-bold">+52 56 1387 0288</a>
                </div>
                <div>
                    <h3 class="text-white text-lg font-semibold mb-4">Servicios</h3>
                    <a href="#" class="block mb-2 hover:text-[#FFCD00] text-[12px] uppercase">Ingeniería Estructural</a>
                    <a href="#" class="block mb-2 hover:text-[#FFCD00] text-[12px] uppercase">Diseño Arquitectónico</a>
                    <a href="#" class="block hover:text-[#FFCD00] text-[12px] uppercase">Consultoría Aura SM</a>
                </div>
                <div>
                    <h3 class="text-white text-lg font-semibold mb-4">Síguenos</h3>
                    <div class="flex space-x-4">
                        <a href="#" class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center hover:bg-[#FFCD00] transition-colors"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center hover:bg-[#FFCD00] transition-colors"><i class="fab fa-pinterest"></i></a>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-800 pt-8 text-center text-[10px] uppercase tracking-widest font-bold">
                <p>&copy; 2026 espacioSM. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
        // URL DE TU GOOGLE APPS SCRIPT (CEREBRO DEEPSEEK)
        const GAS_URL = "URL_DE_TU_SCRIPT_AQUI";

        // AURA SM - CARACTERIZACIÓN COMPLETA CON LIBERTAD ESTRATÉGICA
        const AURA_SYSTEM_PROMPT = `Nombre del Agente: Aura SM

Identidad: Eres la inteligencia estratégica y embajadora técnica de espacioSM, el despacho de arquitectura e ingeniería del Arq. San Miguel. Tu propósito es guiar al cliente a través de un diagnóstico de necesidades detallado, preparando el terreno para la consulta técnica final.

1. Tono y Personalidad:
- Ejecutivo y Profesional pero con calidez estratégica.
- Minimalista y Directo: Evita saludos largos o adulaciones.
- Estética Visual: Negro, Amarillo Caterpillar y Blanco. Fuerte, industrial y precisa.

2. Lógica de Interacción:
- LIBERTAD ESTRATÉGICA: Puedes dar sugerencias prácticas y conversacionales. No todo es derivación.
- Ejemplo: Si alguien pregunta por una cuatrimoto, NO derivar automáticamente. Responde algo como: "Te sugiero lo comentes con el Arq. San Miguel. Normalmente él busca optimizar espacios pensando a futuro; tu diseño contemplará el espacio que tienes y tu tipo de vehículo."
- Sé resolutivo y humano dentro del marco técnico.

3. Tips de espacioSM INTERACTIVOS:
- Los tips DEBEN ser dinámicos y personalizados según las respuestas del usuario.
- Ejemplo: Si es maestro → sugerir espacio para home office o biblioteca.
- Ejemplo: Si es músico → sugerir materiales acústicos y aislamiento.
- Ejemplo: Si tiene 6+ habitantes → sugerir cisterna de mayor capacidad y flujos eficientes.
- Ejemplo: Si tiene vehículo eléctrico → sugerir preparación para estación de carga.
- Ejemplo: Si es adulto mayor → sugerir baño sin barreras en planta baja.
- Máximo 20 palabras, lenguaje claro, sin tecnicismos innecesarios.

4. Estrategia Legal (Licencias):
- Postura: La licencia es innegociable para la seguridad del patrimonio.
- Si usuario NO tiene licencia: "La licencia es la garantía legal de tu inversión. Cualquier estrategia de inicio de obra o regularización técnica debe ser validada y autorizada personalmente por el Arq. San Miguel para mitigar riesgos."

5. Reglas de Negocio:
- Derivación por costos/cálculos exactos: "Ese nivel de precisión requiere un análisis de sitio que el Arq. San Miguel realizará tras recibir este diagnóstico."
- Privacidad: Asegura que los datos están protegidos.
- BITÁCORA: Lleva registro de TODA la conversación.`;

        // Historial completo de conversación con Aura SM
        let auraConversation = [
            { role: "system", content: AURA_SYSTEM_PROMPT }
        ];

        // Bitácora completa del proyecto
        let projectLog = {
            responses: {},
            auraInteractions: [],
            tips: []
        };

        const questions = [
            { step: 1, q: "Identificación del Cliente", fields: ["Nombre", "Email", "Ocupación"], type: "multi", tip: "Perfil del cliente define la narrativa del proyecto." },
            { step: 1, q: "Ubicación y M2 del Terreno", fields: ["Ubicación", "M2 Aproximados"], type: "multi", tip: "Los m² definen el área libre permitida por normativa." },
            { step: 1, q: "¿Cuentas con licencia?", field: "licencia", type: "opt", options: ["Sí", "No", "Tratar con Arq. San Miguel"], tip: "La licencia protege tu patrimonio." },
            { step: 2, q: "¿Número exacto de habitantes?", field: "habitantes", type: "opt", options: ["1", "2", "3", "4", "5", "6+"], tip: "Más personas = mayor capacidad en cisterna y flujos eficientes." },
            { step: 2, q: "Tipo de habitantes (Multiselección)", field: "tipos", type: "multi-opt", options: ["Infante", "Joven", "Adulto", "Adulto Mayor"], tip: "Diseñamos para cada etapa de la vida." },
            { step: 3, q: "¿Cuántos vehículos posee?", field: "autos_n", type: "opt", options: ["0", "1", "2", "3", "4+"], tip: "Claros amplios = cocheras sin columnas." },
            { step: 3, q: "¿Tipo de vehículo?", field: "autos_t", type: "multi-opt", options: ["Sedán", "SUV", "Moto", "Eléctrico", "Cuatrimoto", "Otro"], hasOther: true, tip: "Vehículo eléctrico requiere preparación para estación de carga." },
            { step: 3, q: "¿Equipamiento especial? (Piano, Taller, Pecera...)", field: "especiales", type: "multi-opt", options: ["Estudio", "Taller", "Gimnasio", "Piano", "Instrumentos musicales", "Otro"], hasOther: true, tip: "Equipos pesados requieren análisis de carga en losas." },
            { step: 4, q: "Estilo Arquitectónico predilecto", field: "estilo", type: "visual", options: [
                { name: "Minimalista", img: "https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=400" },
                { name: "Moderno", img: "https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=400" },
                { name: "Industrial", img: "https://images.unsplash.com/photo-1515263487990-61b07816b324?w=400" },
                { name: "Mexicano", img: "https://images.unsplash.com/photo-1518780664697-55e3ad937233?w=400" }
            ], tip: "Tu estilo define la materialidad." },
            { step: 4, q: "¿En qué espacios quieres poner más atención o presupuesto?", field: "prioridad_acabados", type: "multi-opt", options: ["Pisos", "Paredes", "Techos", "Puertas y ventanas", "Otro"], hasOther: true, tip: "Invertir donde realmente importa." },
            { step: 4, q: "¿Dónde pasas más tiempo en tu día a día?", field: "espacios_uso", type: "multi-opt", options: ["Sala", "Cocina", "Recámara", "Estudio", "Comedor", "Jardín o patio", "Otro"], hasOther: true, tip: "Los espacios de mayor uso merecen mejor confort." },
            { step: 4, q: "¿Te interesa usar materiales ecológicos o locales?", field: "material_sostenible", type: "opt", options: ["Sí", "No", "Lo evaluamos después"], tip: "Materiales locales = menor mantenimiento." },
            { step: 4, q: "Aura SM Chat: Dudas o ajustes finales", field: "chat", type: "chat", tip: "Consolidando bitácora para el Arq. San Miguel." }
        ];

        let current = 0, responses = {}, selected = [], interactionLog = [];

        // ===== TIPS INTERACTIVOS =====
        function generateDynamicTip() {
            const q = questions[current];
            let tip = q.tip;

            // Personalizar tip según respuestas acumuladas
            if (responses.ocupacion?.toLowerCase().includes("maestro") || responses.ocupacion?.toLowerCase().includes("profesor")) {
                tip = "Home office o biblioteca. El Arq. San Miguel integra espacios de concentración sin sacrificar luz natural.";
            }
            else if (responses.especiales?.includes("Instrumentos musicales") || responses.especiales?.includes("Piano")) {
                tip = "Aislamiento acústico en muros y losas. Músico necesita ensayar sin molestar ni ser molestado.";
            }
            else if (responses.habitantes === "6+" || responses.habitantes === "5" || responses.habitantes === "4") {
                tip = "Familias numerosas. El Arq. optimiza flujos y dimensiona cisterna para días de alto consumo.";
            }
            else if (responses.autos_t?.includes("Eléctrico")) {
                tip = "Preparación para estación de carga. Mejor hacer la preinstalación ahora que romper acabados después.";
            }
            else if (responses.tipos?.includes("Adulto Mayor")) {
                tip = "Baño sin barreras en planta baja. Pensar en la movilidad futura desde el inicio cuesta menos.";
            }
            else if (responses.espacios_uso?.includes("Jardín o patio")) {
                tip = "Integración interior-exterior. Los patios bien diseñados amplían visualmente la casa.";
            }
            else if (responses.prioridad_acabados?.includes("Pisos")) {
                tip = "Pisos es inversión correcta. Es lo que más se usa y lo que más valor de reventa genera.";
            }

            return tip;
        }

        // ===== FUNCIONES DEL QUIZ =====
        function initQuiz() { 
            document.getElementById('tracker').classList.remove('hidden'); 
            render(); 
        }

        async function render() {
            const q = questions[current], area = document.getElementById('main-render');
            updateProg();

            let html = `<div class="fade-in space-y-6"><p class="text-[9px] font-black text-gray-400 uppercase tracking-widest italic">Paso ${current + 1}/${questions.length}</p><h2 class="text-xl font-black uppercase italic border-l-8 border-black pl-4 leading-tight">${q.q}</h2>`;

            if (q.type === "multi") {
                q.fields.forEach(f => {
                    let valor = responses[f] || "";
                    html += `<input type="text" id="${f}" placeholder="${f.toUpperCase()}" value="${valor}" class="input-underline mb-4">`;
                });
            } else if (q.type === "opt") {
                html += `<div class="grid grid-cols-2 gap-2">`;
                q.options.forEach(o => html += `<button onclick="saveAndNext('${o}')" class="btn-option">${o}</button>`);
                html += `</div>`;
            } else if (q.type === "multi-opt") {
                // Restaurar selecciones previas
                if (responses[q.field]) {
                    selected = responses[q.field].split(", ").map(s => s.replace(/ \(.*\)$/, ''));
                }
                html += `<div class="grid grid-cols-2 gap-2">`;
                q.options.forEach(o => html += `<button onclick="toggleM('${o}')" class="btn-option ${selected.includes(o) ? 'active' : ''}">${o}</button>`);
                html += `</div>`;
                if(q.hasOther && selected.includes("Otro")) {
                    let otherVal = responses[q.field]?.match(/\(([^)]+)\)/)?.[1] || "";
                    html += `<input type="text" id="other-val" placeholder="ESPECIFICA AQUÍ..." value="${otherVal}" class="input-underline mt-4 text-xs">`;
                }
            } else if (q.type === "visual") {
                html += `<div class="grid grid-cols-2 gap-3">`;
                q.options.forEach(o => {
                    let selected = responses.estilo === o.name ? 'active' : '';
                    html += `<div onclick="saveAndNext('${o.name}')" class="visual-card p-1 bg-white ${selected}"><img src="${o.img}" class="w-full h-20 object-cover grayscale hover:grayscale-0 transition"><p class="text-[8px] font-black text-center mt-1 uppercase">${o.name}</p></div>`;
                });
                html += `</div>`;
            } else if (q.type === "chat") {
                html += `<div class="bg-gray-100 p-4 border-l-4 border-[#FFCD00] text-[10px] font-bold mb-4 italic">Aura: "He analizado tus respuestas. Todo indica un proyecto sólido. ¿Deseas agregar alguna nota final para el Arq. San Miguel?"</div><textarea id="chat-val" class="w-full border-4 border-black p-4 text-xs font-bold uppercase h-32" placeholder="EJ: ME PREOCUPA EL TIEMPO DE OBRA...">${responses.chat || ''}</textarea>`;
            }

            if(q.type !== "opt" && q.type !== "visual") {
                html += `<button onclick="handleNext()" class="btn-primary-sm w-full py-4 mt-8">Siguiente Paso</button>`;
            }
            area.innerHTML = html;
            
            // Mostrar tip DINÁMICO
            document.getElementById('tip-box').classList.remove('hidden');
            document.getElementById('tip-text').innerText = generateDynamicTip();
        }

        function toggleM(v) {
            const i = selected.indexOf(v);
            if(i > -1) selected.splice(i, 1); else selected.push(v);
            render();
        }

        function handleNext() {
            const q = questions[current];
            let val = "";
            
            if(q.type === "multi") {
                if(q.fields.some(f => !document.getElementById(f).value)) return alert("Favor de llenar todos los campos.");
                q.fields.forEach(f => {
                    responses[f] = document.getElementById(f).value;
                });
                val = q.fields.map(f => responses[f]).join(" | ");
            } else if(q.type === "multi-opt") {
                if(selected.length === 0) return alert("Selecciona al menos una opción.");
                const other = document.getElementById('other-val')?.value;
                if(selected.includes("Otro") && !other) return alert("Especifique el campo 'Otro'.");
                val = selected.join(", ") + (other ? " (" + other + ")" : "");
                selected = [];
            } else if(q.type === "chat") {
                val = document.getElementById('chat-val').value || "Sin comentarios adicionales.";
            }
            
            saveAndNext(val);
        }

        async function saveAndNext(v) {
            const q = questions[current];
            responses[q.field || "data_" + current] = v;
            responses[q.field || q.fields?.[0]] = v;
            
            interactionLog.push({ 
                step: current,
                pregunta: q.q, 
                respuesta: v,
                timestamp: new Date().toISOString()
            });
            
            projectLog.responses = responses;
            
            if(current < questions.length - 1) { 
                current++; 
                render(); 
            } else { 
                finish(); 
            }
        }

        function updateProg() {
            const p = (current / (questions.length - 1)) * 100;
            document.getElementById('prog-line').style.width = p + "%";
            for(let i=1; i<=4; i++) {
                const dot = document.getElementById(`d-${i}`);
                if(i <= questions[current].step) {
                    dot.classList.add('bg-black');
                    dot.classList.remove('bg-white');
                    dot.classList.add('text-[#FFCD00]');
                    dot.classList.remove('text-gray-300');
                }
            }
        }

        // ===== AURA SM - CON LIBERTAD ESTRATÉGICA =====
        function openAuraModal() {
            document.getElementById('auraModal').classList.add('flex');
            document.getElementById('auraModal').classList.remove('hidden');
        }

        function closeAuraModal() {
            document.getElementById('auraModal').classList.add('hidden');
            document.getElementById('auraModal').classList.remove('flex');
        }

        async function sendAuraMessage() {
            const input = document.getElementById('auraChatInput');
            const message = input.value.trim();
            if (!message) return;

            // Agregar mensaje del usuario
            const messagesDiv = document.getElementById('auraChatMessages');
            messagesDiv.innerHTML += `
                <div class="flex gap-3 items-start justify-end">
                    <div class="bg-black text-white p-3 border-2 border-[#FFCD00] text-[11px] font-bold max-w-[80%]">
                        ${message}
                    </div>
                    <div class="w-8 h-8 rounded-full bg-[#FFCD00] flex-shrink-0 flex items-center justify-center border-2 border-black">
                        <i class="fas fa-user text-black text-xs"></i>
                    </div>
                </div>
            `;

            input.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Guardar en bitácora
            projectLog.auraInteractions.push({
                user: message,
                timestamp: new Date().toISOString()
            });

            // Indicador de escritura
            messagesDiv.innerHTML += `
                <div id="typingIndicator" class="flex gap-3 items-start">
                    <div class="w-8 h-8 rounded-full bg-black flex-shrink-0 flex items-center justify-center border border-[#FFCD00]">
                        <i class="fas fa-robot text-[#FFCD00] text-xs"></i>
                    </div>
                    <div class="bg-white p-3 border-2 border-black text-[11px] font-bold">
                        Aura SM está escribiendo...
                    </div>
                </div>
            `;

            // ===== AURA SM - RESPUESTAS CON LIBERTAD ESTRATÉGICA =====
            setTimeout(() => {
                document.getElementById('typingIndicator')?.remove();
                
                let response = "";
                
                // Detectar vehículos especiales (cuatrimoto, etc.)
                if (message.toLowerCase().includes("cuatrimoto") || message.toLowerCase().includes("atv") || 
                    (message.toLowerCase().includes("moto") && message.toLowerCase().includes("4x4"))) {
                    response = "Aura SM: Te sugiero lo comentes con el Arq. San Miguel. Normalmente él busca optimizar espacios pensando a futuro; tu diseño contemplará el espacio que tienes y tu tipo de vehículo. Muchos clientes empiezan con una cuatrimoto y después suman más.";
                }
                // Licencia
                else if (message.toLowerCase().includes("licencia") || message.toLowerCase().includes("permiso")) {
                    if (responses.licencia === "No") {
                        response = "Aura SM: La licencia es la garantía legal de tu inversión. Cualquier estrategia de inicio de obra o regularización técnica debe ser validada y autorizada personalmente por el Arq. San Miguel para mitigar riesgos.";
                    } else {
                        response = "Aura SM: La licencia es tu respaldo. El Arq. San Miguel siempre trabaja con proyectos dictaminados para proteger tu patrimonio.";
                    }
                }
                // Ocupación / Profesión
                else if (responses.Ocupación?.toLowerCase().includes("maestro") || responses.Ocupación?.toLowerCase().includes("profesor") || 
                         message.toLowerCase().includes("maestro") || message.toLowerCase().includes("profesor")) {
                    response = "Aura SM: ¿Trabajas desde casa? El Arq. San Miguel diseña espacios de estudio con buena iluminación natural y aislamiento acústico para que puedas concentrarte.";
                }
                // Músico
                else if (responses.especiales?.includes("Instrumentos musicales") || responses.especiales?.includes("Piano") ||
                         message.toLowerCase().includes("músico") || message.toLowerCase().includes("piano") || message.toLowerCase().includes("guitarra")) {
                    response = "Aura SM: Para músicos, el Arq. San Miguel recomienda muros de doble tabique y losas con capa de compresión. El sonido se queda en tu espacio y no molesta a los vecinos.";
                }
                // Adulto mayor
                else if (responses.tipos?.includes("Adulto Mayor") || message.toLowerCase().includes("adulto") || message.toLowerCase().includes("abuelo")) {
                    response = "Aura SM: Pensar en movilidad futura desde ahora es inteligente. El Arq. San Miguel suele dejar prevista una recámara y baño completo en planta baja. Cuesta menos que una remodelación.";
                }
                // Costos
                else if (message.toLowerCase().includes("costo") || message.toLowerCase().includes("precio") || message.toLowerCase().includes("presupuesto") || message.toLowerCase().includes("cuanto cuesta")) {
                    response = "Aura SM: Ese nivel de precisión requiere un análisis de sitio que el Arq. San Miguel realizará tras recibir este diagnóstico. Cada proyecto es único y el terreno define muchas variables.";
                }
                // Default - conversacional
                else {
                    response = "Aura SM: Gracias por compartirlo. Queda registrado en tu bitácora para que el Arq. San Miguel lo revise. ¿Algo más que debamos saber para tu diagnóstico?";
                }

                // Guardar respuesta en bitácora
                projectLog.auraInteractions[projectLog.auraInteractions.length - 1].aura = response;

                messagesDiv.innerHTML += `
                    <div class="flex gap-3 items-start">
                        <div class="w-8 h-8 rounded-full bg-black flex-shrink-0 flex items-center justify-center border border-[#FFCD00]">
                            <i class="fas fa-robot text-[#FFCD00] text-xs"></i>
                        </div>
                        <div class="bg-white p-3 border-2 border-black text-[11px] font-bold leading-relaxed max-w-[80%]">
                            ${response}
                        </div>
                    </div>
                `;
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 1200);
        }

        function askAura() {
            openAuraModal();
        }

        function finish() {
            // Generar reporte completo para WhatsApp
            let ocupacion = responses.Ocupación || responses.data_0?.split(" | ")[2] || "No especificada";
            let nombre = responses.Nombre || responses.data_0?.split(" | ")[0] || "Cliente";
            let ubicacion = responses.Ubicación || responses.data_1?.split(" | ")[0] || "No especificada";
            
            const waMsg = `Hola Arq. San Miguel, Aura SM te envía el diagnóstico completo:\n\n` +
                         `Cliente: ${nombre}\n` +
                         `Ocupación: ${ocupacion}\n` +
                         `Ubicación: ${ubicacion}\n` +
                         `Licencia: ${responses.licencia || "No especificado"}\n` +
                         `Habitantes: ${responses.habitantes || "No especificado"} (${responses.tipos || "No especificado"})\n` +
                         `Vehículos: ${responses.autos_n || "0"} - ${responses.autos_t || "No especificado"}\n` +
                         `Equipamiento especial: ${responses.especiales || "Ninguno"}\n` +
                         `Estilo: ${responses.estilo || "No especificado"}\n` +
                         `Acabados prioritarios: ${responses.prioridad_acabados || "No especificado"}\n` +
                         `Espacios de uso: ${responses.espacios_uso || "No especificado"}\n` +
                         `Material sostenible: ${responses.material_sostenible || "No especificado"}\n` +
                         `Notas del cliente: ${responses.chat || "Sin comentarios"}\n\n` +
                         `Interacciones con Aura SM: ${projectLog.auraInteractions.length} consultas\n` +
                         `Bitácora completa disponible en Drive.`;

            document.getElementById('main-render').innerHTML = `
                <div class="text-center space-y-8 fade-in">
                    <h2 class="text-3xl font-black italic uppercase tracking-tighter">Reporte <span class="text-[#FFCD00]">espacioSM</span> Listo</h2>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-8">Tu bitácora ha sido generada con ${interactionLog.length} respuestas y ${projectLog.auraInteractions.length} interacciones con Aura SM.</p>
                    <a href="https://wa.me/525613870288?text=${encodeURIComponent(waMsg)}" target="_blank" class="btn-primary-sm block w-full py-6 shadow-[10px_10px_0px_0px_rgba(0,0,0,1)]">Enviar al Arq. San Miguel</a>
                    <p class="text-[8px] text-gray-500 mt-4">Todos los datos están protegidos · Uso exclusivo espacioSM</p>
                </div>
            `;
            document.getElementById('tip-box').classList.add('hidden');
            
            // Aquí se enviaría a Google Apps Script
            console.log("Proyecto completo:", projectLog);
            console.log("Respuestas:", responses);
            console.log("Bitácora Aura:", projectLog.auraInteractions);
        }
    </script>
</body>
</html>
