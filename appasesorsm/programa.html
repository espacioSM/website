<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura SM Engine | espacioSM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary-color: #FFCD00; --primary-dark: #E6B800; }
        body { font-family: 'Inter', sans-serif; color: #000; background-color: #fff; overflow-x: hidden; }
        
        .nav-scrolled { background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 2px solid #000; }
        .sm-card { border: 3px solid #000; box-shadow: 12px 12px 0px 0px var(--primary-color); }
        .btn-primary-sm { background-color: var(--primary-color); color: #000; font-weight: 800; text-transform: uppercase; transition: 0.3s; border: 2px solid #000; letter-spacing: 0.1em; }
        .btn-primary-sm:hover { background-color: #000; color: var(--primary-color); transform: translateY(-2px); }
        .btn-secondary-sm { background-color: transparent; color: #000; font-weight: 700; text-transform: uppercase; transition: 0.3s; border: 2px solid #000; letter-spacing: 0.1em; }
        .btn-secondary-sm:hover { background-color: #f0f0f0; transform: translateY(-2px); }
        
        .input-underline { border-bottom: 2px solid #000; width: 100%; padding: 12px 0; font-weight: 700; text-transform: uppercase; outline: none; background: transparent; }
        .btn-option { border: 2px solid #E5E7EB; padding: 14px; text-align: left; font-weight: 700; font-size: 11px; text-transform: uppercase; transition: 0.2s; width: 100%; }
        .btn-option:hover { border-color: #000; }
        .btn-option.active { border-color: #000; background-color: var(--primary-color); color: #000; }

        .visual-card { border: 2px solid #E5E7EB; cursor: pointer; transition: 0.3s; grayscale: 100%; opacity: 0.7; }
        .visual-card:hover, .visual-card.active { border-color: #000; grayscale: 0%; opacity: 1; box-shadow: 5px 5px 0px 0px var(--primary-color); }

        .aura-bubble { animation: float 3s ease-in-out infinite; z-index: 1000; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        textarea { resize: vertical; min-height: 80px; }
        
        .selected-image-preview { border: 4px solid var(--primary-color); transform: scale(1.02); }
    </style>
</head>
<body class="antialiased">

    <nav id="navbar" class="fixed top-0 left-0 right-0 z-50 transition-all duration-300 py-4 nav-scrolled">
        <div class="max-w-7xl mx-auto px-6 md:px-12 flex justify-between items-center">
            <a href="https://www.espaciosm.art" class="flex items-center">
                <span class="text-xl font-bold">espacio<span class="text-[#FFCD00]">SM</span></span>
            </a>
            <div class="hidden md:flex items-center space-x-8">
                <a href="/casa-del-arbol/del-arbol.html" class="text-gray-800 hover:text-[#FFCD00] font-bold text-[11px] uppercase tracking-widest">Proyectos</a>
                <a href="/contacto.html" class="text-gray-800 hover:text-[#FFCD00] font-bold text-[11px] uppercase tracking-widest">Contacto</a>
                <a href="#engine" class="bg-[#FFCD00] text-black px-4 py-2 rounded-md font-black text-[10px] uppercase tracking-widest border-2 border-black">Diagn√≥stico Aura</a>
            </div>
        </div>
    </nav>

    <div onclick="openAuraModal()" class="aura-bubble fixed bottom-8 right-8 cursor-pointer flex flex-col items-center">
        <div class="bg-black text-[#FFCD00] w-14 h-14 rounded-full flex items-center justify-center shadow-2xl border-2 border-[#FFCD00]">
            <i class="fas fa-robot text-2xl"></i>
        </div>
        <span class="bg-black text-white text-[7px] font-black px-2 py-1 rounded mt-2 uppercase tracking-tighter">Consultar Aura SM</span>
    </div>

    <div id="auraModal" class="fixed inset-0 bg-black/90 z-[1001] hidden items-center justify-center p-4">
        <div class="bg-white sm-card max-w-2xl w-full max-h-[85vh] flex flex-col">
            <div class="bg-black p-4 flex justify-between items-center border-b-4 border-[#FFCD00]">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-[#FFCD00] flex items-center justify-center text-black font-black border-2 border-white text-xs">SM</div>
                    <span class="text-white text-[12px] font-black uppercase tracking-widest">Aura SM ¬∑ Consultor√≠a</span>
                </div>
                <button onclick="closeAuraModal()" class="text-white hover:text-[#FFCD00] text-2xl font-bold">&times;</button>
            </div>
            <div id="auraChatMessages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50">
                <div class="flex gap-3 items-start">
                    <div class="bg-white p-4 border-2 border-black text-[11px] font-bold leading-relaxed max-w-[90%]">
                        Aura SM: Estoy aqu√≠ para apoyarte. ¬øDeseas que te explique la importancia t√©cnica de esta pregunta o tienes alguna duda para el Arq. San Miguel?
                    </div>
                </div>
            </div>
            <div class="p-4 border-t-2 border-black bg-white">
                <div class="flex gap-2">
                    <input type="text" id="auraChatInput" placeholder="PREGUNTA AQU√ç..." class="flex-1 border-2 border-black p-4 text-[10px] font-bold uppercase outline-none" onkeypress="if(event.key==='Enter') sendAuraMessage()">
                    <button onclick="sendAuraMessage()" class="bg-black text-[#FFCD00] px-6 font-black uppercase text-[10px] border-2 border-[#FFCD00]">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <section id="engine" class="pt-32 pb-24 px-6 bg-gray-50 min-h-screen">
        <div class="max-w-2xl mx-auto">
            <div id="tracker" class="hidden flex justify-between mb-12 relative px-4">
                <div class="absolute top-5 left-0 w-full h-[1px] bg-gray-200 z-0"></div>
                <div id="prog-line" class="absolute top-5 left-0 h-[2px] bg-black z-0 transition-all duration-700"></div>
                <div class="relative z-10 flex flex-col items-center"><div id="d-1" class="w-10 h-10 rounded-full bg-black text-[#FFCD00] flex items-center justify-center border-2 border-[#FFCD00] text-[10px] font-bold shadow-lg">1</div><span class="text-[7px] font-black mt-1 uppercase">Perfil</span></div>
                <div class="relative z-10 flex flex-col items-center"><div id="d-2" class="w-10 h-10 rounded-full bg-white border-2 border-gray-200 text-gray-300 flex items-center justify-center text-[10px] font-bold">2</div><span class="text-[7px] font-black mt-1 uppercase">Alcance</span></div>
                <div class="relative z-10 flex flex-col items-center"><div id="d-3" class="w-10 h-10 rounded-full bg-white border-2 border-gray-200 text-gray-300 flex items-center justify-center text-[10px] font-bold">3</div><span class="text-[7px] font-black mt-1 uppercase">Estilo</span></div>
                <div class="relative z-10 flex flex-col items-center"><div id="d-4" class="w-10 h-10 rounded-full bg-white border-2 border-gray-200 text-gray-300 flex items-center justify-center text-[10px] font-bold">4</div><span class="text-[7px] font-black mt-1 uppercase">Movilidad</span></div>
                <div class="relative z-10 flex flex-col items-center"><div id="d-5" class="w-10 h-10 rounded-full bg-white border-2 border-gray-200 text-gray-300 flex items-center justify-center text-[10px] font-bold">5</div><span class="text-[7px] font-black mt-1 uppercase">Arquitectura</span></div>
                <div class="relative z-10 flex flex-col items-center"><div id="d-6" class="w-10 h-10 rounded-full bg-white border-2 border-gray-200 text-gray-300 flex items-center justify-center text-[10px] font-bold">6</div><span class="text-[7px] font-black mt-1 uppercase">Est√©tica</span></div>
                <div class="relative z-10 flex flex-col items-center"><div id="d-7" class="w-10 h-10 rounded-full bg-white border-2 border-gray-200 text-gray-300 flex items-center justify-center text-[10px] font-bold">7</div><span class="text-[7px] font-black mt-1 uppercase">Tecnolog√≠a</span></div>
            </div>

            <div class="bg-white sm-card rounded-sm overflow-hidden">
                <div class="bg-black p-4 flex justify-between items-center text-white border-b-4 border-[#FFCD00]">
                    <span class="text-[10px] font-black uppercase tracking-widest italic">Aura SM Engine</span>
                    <div class="flex items-center gap-2"><div class="w-2 h-2 bg-[#FFCD00] rounded-full animate-pulse"></div><span class="text-[8px] font-bold uppercase">Activo</span></div>
                </div>

                <div id="main-render" class="p-8 md:p-12 min-h-[460px] flex flex-col justify-center">
                    <div class="fade-in space-y-6">
                        <h2 class="text-3xl font-black uppercase italic tracking-tighter">Consultor√≠a de Autor</h2>
                        <p class="text-[11px] font-bold text-gray-600 uppercase leading-relaxed">
                            Bienvenido al motor de diagn√≥stico de <strong>espacioSM</strong>. <br><br>
                            A continuaci√≥n definiremos los par√°metros de tu proyecto. Durante el proceso, <strong>Aura SM</strong> te acompa√±ar√° resolviendo dudas y brind√°ndote tips estrat√©gicos.
                        </p>
                        <button onclick="initQuiz()" class="btn-primary-sm w-full py-5 text-sm shadow-xl">Iniciar Diagn√≥stico</button>
                    </div>
                </div>

                <div id="tip-box" class="hidden bg-gray-50 border-t-2 border-black p-6">
                    <div class="flex gap-4 items-start">
                        <div class="w-10 h-10 rounded-full bg-[#FFCD00] flex items-center justify-center text-[10px] font-black italic border-2 border-black flex-shrink-0">SM</div>
                        <div class="space-y-1">
                            <p class="text-[8px] font-black uppercase text-white bg-black px-2 py-0.5 inline-block">Tip de espacioSM</p>
                            <p id="tip-text" class="text-[11px] font-bold italic text-gray-800 leading-relaxed uppercase tracking-tight"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-black text-gray-300 py-12 px-6 md:px-12 border-t-4 border-[#FFCD00]">
        <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
            <div>
                <h3 class="text-white text-lg font-bold mb-4 italic">espacio<span class="text-[#FFCD00]">SM</span></h3>
                <p class="text-[11px] font-bold uppercase tracking-widest text-gray-500">Ingenier√≠a estructural y arquitectura de autor. Traducimos la complejidad en seguridad t√©cnica.</p>
            </div>
            <div>
                <h3 class="text-white text-[11px] font-black uppercase tracking-widest mb-4">Contacto</h3>
                <a href="mailto:contacto@espaciosm.art" class="block mb-2 hover:text-[#FFCD00] text-[11px] font-bold">contacto@espaciosm.art</a>
                <a href="tel:+525613870288" class="block hover:text-[#FFCD00] text-[12px] font-black tracking-widest">+52 56 1387 0288</a>
            </div>
            <div class="md:text-right">
                <p class="text-[9px] font-bold uppercase tracking-[0.3em] text-gray-600">&copy; 2026 espacioSM. Todos los derechos reservados.</p>
                <a href="#" class="text-[9px] hover:text-[#FFCD00] block mt-2">Aviso de Privacidad</a>
            </div>
        </div>
    </footer>

    <script>
        // ===== TODAS LAS PREGUNTAS INTEGRADAS CON OPCIONES "OTRO" =====
        const quizData = [
            // I. PERFIL DEL CLIENTE Y UBICACI√ìN (PASO 1)
            { step: 1, id: "perfil", q: "Perfil del Cliente y Ubicaci√≥n", fields: [
                "Correo electr√≥nico", 
                "Nombre del Cliente", 
                "Estructura del n√∫cleo familiar (Ej: Pareja, 2 hijos, suegros)", 
                "Ocupaci√≥n"
            ], type: "multi", tip: "Conocer su perfil nos permite dise√±ar espacios que se adapten a su realidad y estilo de vida." },
            { step: 1, id: "ubicacion_maps", q: "Ubicaci√≥n del terreno a construir", field: "ubicacion_maps", type: "text", placeholder: "Compartir enlace de Google Maps", tip: "La ubicaci√≥n define el clima, la topograf√≠a y las normativas locales aplicables." },
            
            // II. ALCANCE DEL PROYECTO (PASO 2)
            { step: 2, id: "licencia", q: "Situaci√≥n Legal: ¬øTienes Licencia de construcci√≥n o pretendes sacar una?", field: "licencia", type: "opt", options: [
                "S√≠", 
                "No, pretendo sacarla", 
                "Requiero asesor√≠a t√©cnica y legal"
            ], tip: "La licencia es el blindaje legal de tu obra. Evita riesgos de clausura y multas." },
            { step: 2, id: "tipo_trabajo", q: "Tipo de trabajo: Seleccione tipo de trabajo a realizar", field: "tipo_trabajo", type: "opt", options: [
                "Obra Nueva", 
                "Remodelaci√≥n", 
                "Ampliaci√≥n"
            ], tip: "Cada tipo de intervenci√≥n requiere enfoques estructurales diferentes." },
            { step: 2, id: "diagnostico_necesidades", q: "Diagn√≥stico de Necesidades: En caso de ampliaci√≥n o remodelaci√≥n, describe brevemente qu√© deseas hacer y qu√© √°reas de tu vida actual ya no satisface tu espacio.", field: "diagnostico_necesidades", type: "textarea", tip: "Entender sus necesidades actuales nos ayuda a proyectar soluciones que mejoren su calidad de vida." },
            { step: 2, id: "prioridad_inversion", q: "Inversi√≥n y Prioridades: ¬øCu√°l es su prioridad principal respecto a la inversi√≥n?", field: "prioridad_inversion", type: "opt", options: [
                "Maximizar m¬≤", 
                "Equilibrio dise√±o-costo", 
                "Lujo y exclusividad", 
                "Sostenibilidad"
            ], tip: "Su prioridad define d√≥nde concentramos los recursos t√©cnicos y econ√≥micos." },
            
            // III. USUARIOS Y ESTILO DE VIDA (PASO 3)
            { step: 3, id: "num_usuarios", q: "N√∫mero de usuarios para la Casa Habitaci√≥n", field: "num_usuarios", type: "opt", options: [
                "1", "2", "3", "4", "5", "6+"
            ], tip: "La cantidad de usuarios determina las dimensiones de instalaciones y espacios comunes." },
            { step: 3, id: "perfil_habitantes", q: "Perfil de habitantes: Seleccione qu√© tipo de usuario habitar√° la casa", field: "perfil_habitantes", type: "multi-opt", options: [
                "Infante", "Adolescente", "Adulto Joven", "Adulto", "Adulto Mayor"
            ], tip: "Cada etapa de vida requiere consideraciones espec√≠ficas de accesibilidad y confort." },
            { step: 3, id: "vida_social", q: "Vida Social: ¬øRecibe muchas visitas?", field: "vida_social", type: "opt", options: [
                "S√≠, frecuentemente", 
                "Ocasionalmente", 
                "Raramente"
            ], tip: "La vida social define la necesidad de espacios de reuni√≥n y flujos de circulaci√≥n." },
            { step: 3, id: "vision_estilo_vida", q: "Visi√≥n del Estilo de Vida: Al imaginar su proyecto terminado, ¬øcu√°l es la sensaci√≥n principal que desea experimentar?", field: "vision_estilo_vida", type: "opt", options: [
                "Refugio y calma", 
                "Social y abierto", 
                "Productividad y creatividad", 
                "Conexi√≥n natural"
            ], tip: "La sensaci√≥n deseada gu√≠a las decisiones de iluminaci√≥n, materiales y distribuci√≥n." },
            
            // IV. MOVILIDAD Y MASCOTAS (PASO 4)
            { step: 4, id: "vehiculos_actuales", q: "Veh√≠culos actuales: ¬øCu√°ntos veh√≠culos posee?", field: "vehiculos_actuales", type: "opt", options: [
                "0", "1", "2", "3", "4+"
            ], tip: "La cantidad de veh√≠culos define el dimensionamiento de cocheras y accesos." },
            { step: 4, id: "tipo_vehiculos", q: "Tipo de veh√≠culos", field: "tipo_vehiculos", type: "multi-opt", options: [
                "Sed√°n", "SUV", "Pick Up", "Motocicleta", "Otro"
            ], hasOther: true, tip: "El tipo de veh√≠culo determina alturas libres y anchos de circulaci√≥n." },
            { step: 4, id: "proyeccion_vehiculos", q: "Proyecci√≥n a futuro: ¬øTiene intenciones de adquirir uno o m√°s veh√≠culos y de qu√© tipo?", field: "proyeccion_vehiculos", type: "textarea", tip: "Proyectar a futuro evita tener que modificar estructuras m√°s adelante." },
            { step: 4, id: "mascotas", q: "Integraci√≥n de Mascotas: ¬øTiene o planea adquirir alguna mascota? Especificar cu√°l.", field: "mascotas", type: "textarea", tip: "Las mascotas requieren acabados resistentes y √°reas espec√≠ficas." },
            
            // V. PROGRAMA ARQUITECT√ìNICO Y ESPACIOS (PASO 5)
            { step: 5, id: "habitaciones", q: "Habitaciones: N√∫mero de habitaciones deseado", field: "habitaciones", type: "opt", options: [
                "1", "2", "3", "4", "5+"
            ], tip: "El n√∫mero de habitaciones define la distribuci√≥n y los requerimientos estructurales." },
            { step: 5, id: "accesibilidad", q: "Necesidades de Accesibilidad", field: "accesibilidad", type: "multi-opt", options: [
                "Rampas", "Puertas anchas", "Ba√±o adaptado", "Elevador", "Ninguna", "Otro"
            ], hasOther: true, tip: "La accesibilidad universal garantiza que todos puedan habitar el espacio en cualquier etapa." },
            { step: 5, id: "privacidad_confort", q: "Privacidad y Confort: Dimensiones y elementos indispensables que le gustar√≠a tener para su habitaci√≥n", field: "privacidad_confort", type: "textarea", placeholder: "Ej. vestidor, tina, terraza", tip: "Los elementos de confort personalizan su experiencia diaria." },
            { step: 5, id: "requerimientos_especiales", q: "Requerimientos Especiales: ¬øCuenta con pertenencias o mobiliario que requieran un espacio especial? Favor de especificar.", field: "requerimientos_especiales", type: "textarea", tip: "Objetos de gran peso o dimensiones requieren refuerzos estructurales espec√≠ficos." },
            { step: 5, id: "zonas_permanencia", q: "Zonas de Permanencia: Seleccione el lugar donde pasa la mayor parte del tiempo", field: "zonas_permanencia", type: "multi-opt", options: [
                "Dormitorio", "Cocina", "Comedor", "Sala", "Estudio", "Terraza/Patio"
            ], tip: "Las zonas de mayor permanencia merecen atenci√≥n especial en confort y dise√±o." },
            { step: 5, id: "pasatiempos", q: "Pasatiempos: Describa intereses y pasatiempos generales que desee realizar dentro de su proyecto.", field: "pasatiempos", type: "textarea", tip: "Sus pasatiempos pueden requerir espacios espec√≠ficos (taller, estudio, gimnasio)." },
            { step: 5, id: "puntos_dolor", q: "Puntos de Dolor: En base a su experiencia en otras casas, ¬øqu√© cosas le molestan?", field: "puntos_dolor", type: "textarea", placeholder: "Ej. Cocina expuesta, falta de luz, ruidos", tip: "Identificar molestias previas nos ayuda a evitarlas en su nuevo proyecto." },
            
            // VI. EST√âTICA, MATERIALES Y ENTORNO (PASO 6)
            { step: 6, id: "paleta_cromatica", q: "Paleta Crom√°tica: ¬øQu√© tonalidades son sus predilectas?", field: "paleta_cromatica", type: "multi-opt", options: [
                "Neutras", "Oscuras", "Tierra", "Tendencia", "Otro"
            ], hasOther: true, tip: "La paleta crom√°tica define la atm√≥sfera y la percepci√≥n espacial." },
            { step: 6, id: "texturas_pisos", q: "Texturas y Pisos: ¬øQu√© materiales en piso son los que m√°s le gustan?", field: "texturas_pisos", type: "multi-opt", options: [
                "Loseta", "Madera", "M√°rmol", "Concreto aparente", "Laminado", "Otro"
            ], hasOther: true, tip: "Cada material tiene diferentes propiedades t√©rmicas, ac√∫sticas y de mantenimiento." },
            { step: 6, id: "conciencia_sitio", q: "Conciencia del Sitio: ¬øEs importante para ti integrar los elementos naturales existentes del terreno? ¬øCu√°les?", field: "conciencia_sitio", type: "textarea", tip: "Integrar elementos naturales reduce impacto ambiental y crea espacios √∫nicos." },
            { step: 6, id: "estilo_arquitectonico", q: "Estilo Arquitect√≥nico: ¬øQu√© estilo le gusta m√°s? (Selecciona una opci√≥n)", field: "estilo_arquitectonico", type: "visual", options: [
                { name: "Cl√°sico", img: "https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=400" },
                { name: "Moderno", img: "https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=400" },
                { name: "Contempor√°neo", img: "https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=400" },
                { name: "Minimalista", img: "https://images.unsplash.com/photo-1600210492493-0946911123ea?w=400" },
                { name: "Mexicano", img: "https://images.unsplash.com/photo-1518780664697-55e3ad937233?w=400" },
                { name: "Otro", img: "https://images.unsplash.com/photo-1515263487990-61b07816b324?w=400" }
            ], tip: "El estilo define la materialidad y la firma est√©tica de espacioSM." },
            { step: 6, id: "referencias_visuales", q: "Referencias Visuales: ¬øCuenta con un tablero de referentes (Pinterest/Instagram) que definan la est√©tica que busca? (Compartir enlace)", field: "referencias_visuales", type: "text", placeholder: "https://pinterest.com/tu-tablero", tip: "Las referencias visuales nos ayudan a entender sus gustos con precisi√≥n." },
            
            // VII. TECNOLOG√çA Y GESTI√ìN (PASO 7)
            { step: 7, id: "sostenibilidad", q: "Sostenibilidad: ¬øTe gustar√≠a implementar ecotecnolog√≠a?", field: "sostenibilidad", type: "multi-opt", options: [
                "Paneles solares", "Captaci√≥n pluvial", "Biodigestor", "Calentador solar", "Otro"
            ], hasOther: true, tip: "La ecotecnolog√≠a reduce costos operativos y el impacto ambiental." },
            { step: 7, id: "involucramiento", q: "Involucramiento: ¬øC√≥mo visualiza su participaci√≥n durante el proceso de dise√±o y construcci√≥n?", field: "involucramiento", type: "opt", options: [
                "Delegaci√≥n total", 
                "Colaboraci√≥n guiada", 
                "Involucramiento activo"
            ], tip: "Su nivel de involucramiento define la din√°mica de trabajo y toma de decisiones." },
            { step: 7, id: "proposito_patrimonial", q: "Prop√≥sito Patrimonial: ¬øCu√°l es el objetivo final de este proyecto?", field: "proposito_patrimonial", type: "opt", options: [
                "Residencia definitiva", 
                "Inversi√≥n y venta", 
                "Segunda residencia", 
                "Temporal"
            ], tip: "El prop√≥sito define la durabilidad requerida y el retorno de inversi√≥n esperado." },
            { step: 7, id: "final", q: "Aura SM Chat Final", type: "chat", tip: "Consolidando su visi√≥n t√©cnica con los est√°ndares del Arq. San Miguel." }
        ];

        let state = { current: 0, responses: {}, interactionLog: [] };

        function initQuiz() { 
            document.getElementById('tracker').classList.remove('hidden'); 
            render(); 
        }

        function goToPrevious() {
            if (state.current > 0) {
                state.current--;
                render();
            }
        }

        function render() {
            const q = quizData[state.current];
            const area = document.getElementById('main-render');
            updateProg();
            
            if (q.tip) {
                document.getElementById('tip-box').classList.remove('hidden');
                document.getElementById('tip-text').innerText = q.tip;
            }

            let html = `<div class="fade-in space-y-6">`;
            
            // Bot√≥n de regresar (excepto en primera pregunta)
            if (state.current > 0) {
                html += `<button onclick="goToPrevious()" class="btn-secondary-sm px-4 py-2 text-[9px] mb-4 flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> REGRESAR
                </button>`;
            }
            
            html += `<p class="text-[9px] font-black text-gray-400 uppercase tracking-widest italic">Paso ${state.current + 1}/${quizData.length}</p>
                    <h2 class="text-2xl font-black uppercase italic border-l-8 border-black pl-4 leading-tight">${q.q}</h2>`;

            if (q.type === "multi") {
                q.fields.forEach(f => {
                    const fieldId = f.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    html += `<input type="text" id="${fieldId}" placeholder="${f.toUpperCase()}" value="${state.responses[f] || ''}" class="input-underline mb-4">`;
                });
                html += `<button onclick="handleMulti()" class="btn-primary-sm w-full py-4 mt-8">Continuar</button>`;
            } 
            else if (q.type === "text") {
                html += `<input type="text" id="${q.id}" placeholder="${q.placeholder || q.q.toUpperCase()}" value="${state.responses[q.id] || ''}" class="input-underline mb-4">`;
                html += `<button onclick="saveAndNext(document.getElementById('${q.id}').value)" class="btn-primary-sm w-full py-4 mt-8">Continuar</button>`;
            }
            else if (q.type === "textarea") {
                html += `<textarea id="${q.id}" placeholder="${q.placeholder || q.q.toUpperCase()}" class="w-full border-2 border-black p-4 text-[11px] font-bold uppercase outline-none mt-4">${state.responses[q.id] || ''}</textarea>`;
                html += `<button onclick="saveAndNext(document.getElementById('${q.id}').value)" class="btn-primary-sm w-full py-4 mt-8">Continuar</button>`;
            }
            else if (q.type === "opt") {
                html += `<div class="grid grid-cols-2 gap-2 mt-4">`;
                q.options.forEach(o => {
                    const isActive = state.responses[q.id] === o;
                    html += `<button onclick="saveAndNext('${o}')" class="btn-option ${isActive ? 'active' : ''}">${o}</button>`;
                });
                html += `</div>`;
            } 
            else if (q.type === "multi-opt") {
                const currentVals = state.responses[q.id] ? state.responses[q.id].split(", ") : [];
                html += `<div class="grid grid-cols-2 gap-2 mt-4">`;
                q.options.forEach(o => {
                    const isActive = currentVals.some(v => v === o || v.startsWith(o + " ("));
                    html += `<button onclick="toggleM('${o}')" class="btn-option ${isActive ? 'active' : ''}">${o}</button>`;
                });
                html += `</div>`;
                
                if(q.hasOther && currentVals.some(v => v.startsWith("Otro"))) {
                    const otherVal = currentVals.find(v => v.startsWith("Otro"))?.match(/\((.*)\)/)?.[1] || "";
                    html += `<input type="text" id="other-val" placeholder="ESPECIFIQUE OTRO..." value="${otherVal}" class="input-underline mt-4 text-xs">`;
                }
                html += `<button onclick="handleMultiOpt()" class="btn-primary-sm w-full py-4 mt-8">Siguiente Paso</button>`;
            }
            else if (q.type === "visual") {
                html += `<div class="grid grid-cols-2 gap-3 mt-4">`;
                q.options.forEach(o => {
                    const isActive = state.responses[q.id] === o.name;
                    html += `<div onclick="selectVisual('${o.name}')" class="visual-card p-1 bg-white ${isActive ? 'active selected-image-preview' : ''}">
                        <img src="${o.img}" class="w-full h-20 object-cover">
                        <p class="text-[8px] font-bold text-center mt-1 uppercase">${o.name}</p>
                    </div>`;
                });
                html += `</div>`;
                
                // Mostrar la imagen seleccionada actualmente
                if (state.responses[q.id]) {
                    const selectedOption = q.options.find(o => o.name === state.responses[q.id]);
                    if (selectedOption) {
                        html += `<div class="mt-6 p-4 bg-gray-100 border-2 border-black">
                            <p class="text-[8px] font-black uppercase mb-2">ESTILO SELECCIONADO:</p>
                            <div class="flex items-center gap-4">
                                <img src="${selectedOption.img}" class="w-24 h-16 object-cover border-2 border-black">
                                <p class="text-[10px] font-bold">${selectedOption.name}</p>
                            </div>
                        </div>`;
                    }
                }
                
                // Bot√≥n para continuar (solo si hay una selecci√≥n)
                if (state.responses[q.id]) {
                    html += `<button onclick="saveAndNext(state.responses['${q.id}'])" class="btn-primary-sm w-full py-4 mt-8">Continuar</button>`;
                } else {
                    html += `<p class="text-[8px] font-bold text-red-500 mt-4 text-center">Selecciona un estilo para continuar</p>`;
                }
            }
            else if (q.type === "chat") {
                html += `<div class="bg-gray-100 p-4 border-l-4 border-[#FFCD00] text-[10px] font-bold mb-4">Aura: "He analizado todos tus datos y el perfil es s√≥lido. ¬øAlg√∫n comentario final para el Arq. San Miguel?"</div>`;
                html += `<textarea id="chat-final" class="w-full border-4 border-black p-4 text-xs font-bold uppercase h-32 outline-none" placeholder="DUDAS O NOTAS...">${state.responses.final || ''}</textarea>`;
                html += `<button onclick="handleFinal()" class="btn-primary-sm w-full py-4 mt-8">Finalizar Diagn√≥stico</button>`;
            }

            area.innerHTML = html;
        }

        function selectVisual(styleName) {
            const q = quizData[state.current];
            state.responses[q.id] = styleName;
            render(); // Solo actualiza la vista, NO avanza autom√°ticamente
        }

        function toggleM(v) {
            let field = quizData[state.current].id;
            let currentVals = state.responses[field] ? state.responses[field].split(", ") : [];
            const idx = currentVals.indexOf(v);
            
            if (idx > -1) currentVals.splice(idx, 1);
            else currentVals.push(v);
            
            state.responses[field] = currentVals.join(", ");
            render(); 
        }

        function handleMulti() {
            const q = quizData[state.current];
            let allFilled = true;
            
            q.fields.forEach(f => {
                const fieldId = f.toLowerCase().replace(/[^a-z0-9]/g, '_');
                const value = document.getElementById(fieldId)?.value;
                if (!value) allFilled = false;
                else state.responses[f] = value;
            });
            
            if (!allFilled) return alert("Completa todos los campos.");
            saveAndNext("Completado");
        }

        function handleMultiOpt() {
            const field = quizData[state.current].id;
            let val = state.responses[field];
            if(!val) return alert("Selecciona al menos una opci√≥n.");
            
            const otherInput = document.getElementById('other-val');
            if(val.includes("Otro") && otherInput) {
                if(!otherInput.value.trim()) return alert("Especifica el campo 'Otro'.");
                val = val.replace(/Otro/g, `Otro (${otherInput.value})`);
                state.responses[field] = val; // Actualizar con el valor modificado
            }
            saveAndNext(val);
        }

        function handleFinal() { 
            saveAndNext(document.getElementById('chat-final').value || "Sin comentarios finales"); 
        }

        function saveAndNext(v) {
            const currentQ = quizData[state.current];
            state.responses[currentQ.id || "data"] = v;
            
            if(state.current < quizData.length - 1) { 
                state.current++; 
                render(); 
            } else { 
                finish(); 
            }
        }

        function updateProg() {
            const totalSteps = quizData.length - 1;
            const progress = (state.current / totalSteps) * 100;
            document.getElementById('prog-line').style.width = progress + "%";
            
            const currentMainStep = quizData[state.current].step;
            for(let i=1; i<=7; i++) {
                const d = document.getElementById(`d-${i}`);
                if (d) {
                    if (i <= currentMainStep) {
                        d.classList.remove('bg-white', 'border-gray-200', 'text-gray-300');
                        d.classList.add('bg-black', 'border-[#FFCD00]', 'text-[#FFCD00]');
                    } else {
                        d.classList.remove('bg-black', 'border-[#FFCD00]', 'text-[#FFCD00]');
                        d.classList.add('bg-white', 'border-gray-200', 'text-gray-300');
                    }
                }
            }
        }

        function openAuraModal() { 
            document.getElementById('auraModal').classList.remove('hidden'); 
            document.getElementById('auraModal').classList.add('flex'); 
        }
        
        function closeAuraModal() { 
            document.getElementById('auraModal').classList.add('hidden'); 
            document.getElementById('auraModal').classList.remove('flex'); 
        }

        async function sendAuraMessage() {
            const input = document.getElementById('auraChatInput');
            const msg = input.value.trim();
            if (!msg) return;

            const chat = document.getElementById('auraChatMessages');
            chat.innerHTML += `<div class="flex justify-end"><div class="bg-black text-white p-3 border-2 border-[#FFCD00] text-[10px] font-bold max-w-[80%]">${msg}</div></div>`;
            input.value = "";
            chat.scrollTop = chat.scrollHeight;

            setTimeout(() => {
                let resp = "";
                const currentQuestion = quizData[state.current].q;
                
                if (msg.toLowerCase().includes("licencia")) {
                    resp = "Aura SM: La licencia de construcci√≥n es el permiso legal que avala que tu proyecto cumple con las normas urban√≠sticas. Sin ella, la obra puede ser clausurada y recibir multas. El Arq. San Miguel siempre recomienda regularizar este aspecto antes de iniciar.";
                }
                else if (msg.toLowerCase().includes("costo") || msg.toLowerCase().includes("presupuesto")) {
                    resp = "Aura SM: El presupuesto debe considerar: proyecto ejecutivo (5-8% del total), licencias (2-5%), construcci√≥n (100%), y un 10% de imprevistos. ¬øTe gustar√≠a que profundice en alg√∫n aspecto?";
                }
                else if (msg.toLowerCase().includes("material")) {
                    resp = "Aura SM: La elecci√≥n de materiales impacta directamente en la estructura, el mantenimiento y la eficiencia energ√©tica. Por ejemplo, el concreto aparente es durable pero requiere buen control de calidad. ¬øSobre qu√© material tienes duda?";
                }
                else if (msg.toLowerCase().includes("tiempo") || msg.toLowerCase().includes("plazo")) {
                    resp = "Aura SM: Los tiempos t√≠picos: Proyecto ejecutivo (2-4 meses), Licencias (1-3 meses), Construcci√≥n (8-18 meses seg√∫n tama√±o). ¬øQuieres una estimaci√≥n m√°s precisa para tu caso?";
                }
                else {
                    resp = `Aura SM: Entiendo su consulta sobre "${currentQuestion}". He registrado su pregunta para que el Arq. San Miguel la considere en el an√°lisis personalizado. Mientras tanto, ¬øhay alg√∫n aspecto t√©cnico espec√≠fico en el que pueda ayudarle?`;
                }

                chat.innerHTML += `<div class="flex gap-3 items-start">
                    <div class="w-8 h-8 rounded-full bg-black flex items-center justify-center border border-[#FFCD00]">
                        <i class="fas fa-robot text-[#FFCD00] text-xs"></i>
                    </div>
                    <div class="bg-white p-3 border-2 border-black text-[11px] font-bold max-w-[85%]">${resp}</div>
                </div>`;
                chat.scrollTop = chat.scrollHeight;
                state.interactionLog.push({user: msg, aura: resp});
            }, 800);
        }

        function finish() {
            // Mapeo de IDs a nombres m√°s amigables para el informe
            const fieldNames = {
                'Correo electr√≥nico': 'üìß Email',
                'Nombre del Cliente': 'üë§ Cliente',
                'Estructura del n√∫cleo familiar (Ej: Pareja, 2 hijos, suegros)': 'üë™ Familia',
                'Ocupaci√≥n': 'üíº Ocupaci√≥n',
                'ubicacion_maps': 'üìç Ubicaci√≥n',
                'licencia': 'üìã Licencia',
                'tipo_trabajo': 'üèóÔ∏è Tipo de trabajo',
                'diagnostico_necesidades': 'üìù Diagn√≥stico',
                'prioridad_inversion': 'üí∞ Prioridad de inversi√≥n',
                'num_usuarios': 'üë• Usuarios',
                'perfil_habitantes': 'üë§ Perfil habitantes',
                'vida_social': 'üéâ Vida social',
                'vision_estilo_vida': '‚ú® Visi√≥n de vida',
                'vehiculos_actuales': 'üöó Veh√≠culos actuales',
                'tipo_vehiculos': 'üöô Tipo veh√≠culos',
                'proyeccion_vehiculos': 'üîÆ Proyecci√≥n veh√≠culos',
                'mascotas': 'üêæ Mascotas',
                'habitaciones': 'üõèÔ∏è Habitaciones',
                'accesibilidad': '‚ôø Accesibilidad',
                'privacidad_confort': 'üõãÔ∏è Privacidad',
                'requerimientos_especiales': 'üì¶ Requerimientos especiales',
                'zonas_permanencia': '‚è±Ô∏è Zonas de permanencia',
                'pasatiempos': 'üé® Pasatiempos',
                'puntos_dolor': 'üò£ Puntos de dolor',
                'paleta_cromatica': 'üé® Paleta crom√°tica',
                'texturas_pisos': 'üè∫ Texturas pisos',
                'conciencia_sitio': 'üå≥ Conciencia sitio',
                'estilo_arquitectonico': 'üèõÔ∏è Estilo arquitect√≥nico',
                'referencias_visuales': 'üîó Referencias visuales',
                'sostenibilidad': '‚ôªÔ∏è Sostenibilidad',
                'involucramiento': 'ü§ù Involucramiento',
                'proposito_patrimonial': 'üéØ Prop√≥sito'
            };

            // Construir resumen SOLO con respuestas relevantes
            let resumen = "üìã *NUEVO DIAGN√ìSTICO COMPLETADO*\n\n";
            resumen += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
            
            // 1. Datos de contacto (siempre primero)
            if (state.responses['Correo electr√≥nico']) {
                resumen += `üìß *Email:* ${state.responses['Correo electr√≥nico']}\n`;
            }
            if (state.responses['Nombre del Cliente']) {
                resumen += `üë§ *Cliente:* ${state.responses['Nombre del Cliente']}\n`;
            }
            if (state.responses['Estructura del n√∫cleo familiar (Ej: Pareja, 2 hijos, suegros)']) {
                resumen += `üë™ *Familia:* ${state.responses['Estructura del n√∫cleo familiar (Ej: Pareja, 2 hijos, suegros)']}\n`;
            }
            
            resumen += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
            resumen += "*RESPUESTAS PRINCIPALES*\n\n";
            
            // 2. Recorrer solo las respuestas importantes
            const respuestasImportantes = [
                'licencia', 'tipo_trabajo', 'prioridad_inversion', 'num_usuarios',
                'perfil_habitantes', 'vida_social', 'vision_estilo_vida', 'vehiculos_actuales',
                'tipo_vehiculos', 'mascotas', 'habitaciones', 'accesibilidad',
                'estilo_arquitectonico', 'sostenibilidad', 'involucramiento', 'proposito_patrimonial'
            ];
            
            respuestasImportantes.forEach(key => {
                if (state.responses[key] && 
                    typeof state.responses[key] === 'string' && 
                    state.responses[key].length > 0 &&
                    !state.responses[key].includes('[object Object]')) {
                    
                    const nombreAmigable = fieldNames[key] || key;
                    resumen += `‚Ä¢ ${nombreAmigable}: ${state.responses[key]}\n`;
                }
            });
            
            // 3. Agregar campos de texto libre importantes
            const textosLibres = [
                'diagnostico_necesidades', 'proyeccion_vehiculos', 'privacidad_confort',
                'requerimientos_especiales', 'pasatiempos', 'puntos_dolor', 
                'conciencia_sitio', 'referencias_visuales'
            ];
            
            let tieneTextosLibres = false;
            textosLibres.forEach(key => {
                if (state.responses[key] && 
                    typeof state.responses[key] === 'string' && 
                    state.responses[key].length > 3) {
                    
                    if (!tieneTextosLibres) {
                        resumen += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
                        resumen += "*NOTAS Y COMENTARIOS*\n\n";
                        tieneTextosLibres = true;
                    }
                    
                    const nombreAmigable = fieldNames[key] || key;
                    let valor = state.responses[key];
                    if (valor.length > 100) {
                        valor = valor.substring(0, 100) + "...";
                    }
                    resumen += `üìù *${nombreAmigable}:* ${valor}\n`;
                }
            });
            
            // 4. Estad√≠sticas de interacci√≥n con Aura
            resumen += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
            resumen += `üí¨ *Interacciones con Aura:* ${state.interactionLog.length} mensajes\n`;
            
            // 5. Resumen ejecutivo
            resumen += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
            resumen += "‚úÖ Diagn√≥stico listo para revisi√≥n del Arq. San Miguel";

            const waMsg = encodeURIComponent(resumen);
            
            document.getElementById('main-render').innerHTML = `
                <div class="text-center space-y-8 fade-in">
                    <div class="bg-[#FFCD00] p-4 inline-block mx-auto mb-4">
                        <i class="fas fa-check-circle text-black text-4xl"></i>
                    </div>
                    <h2 class="text-3xl font-black uppercase italic tracking-tighter">
                        An√°lisis <span class="text-[#FFCD00]">espacioSM</span> Listo
                    </h2>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-8">
                        Se han registrado ${Object.keys(state.responses).filter(k => state.responses[k] && typeof state.responses[k] === 'string').length} respuestas y ${state.interactionLog.length} interacciones con Aura SM.
                    </p>
                    <a href="https://wa.me/525613870288?text=${waMsg}" target="_blank" 
                       class="btn-primary-sm block w-full py-6 shadow-[10px_10px_0px_0px_rgba(0,0,0,1)] 
                              flex items-center justify-center gap-2">
                        <i class="fab fa-whatsapp text-lg"></i>
                        Enviar Resumen al Arq. San Miguel
                    </a>
                </div>`;
            
            document.getElementById('tip-box').classList.add('hidden');
        }
    </script>
</body>
</html>
